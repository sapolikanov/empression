% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  9pt,
  letterpaper,
  DIV=11,
  numbers=noendperiod]{scrartcl}

\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else  
    % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\setlength{\emergencystretch}{3em} % prevent overfull lines
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
% Make \paragraph and \subparagraph free-standing
\makeatletter
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}{
    \@ifstar
      \xxxParagraphStar
      \xxxParagraphNoStar
  }
  \newcommand{\xxxParagraphStar}[1]{\oldparagraph*{#1}\mbox{}}
  \newcommand{\xxxParagraphNoStar}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}{
    \@ifstar
      \xxxSubParagraphStar
      \xxxSubParagraphNoStar
  }
  \newcommand{\xxxSubParagraphStar}[1]{\oldsubparagraph*{#1}\mbox{}}
  \newcommand{\xxxSubParagraphNoStar}[1]{\oldsubparagraph{#1}\mbox{}}
\fi
\makeatother

\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{35,38,41}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.58,0.85,0.30}{\textbf{\colorbox[rgb]{0.30,0.12,0.14}{#1}}}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.25,0.50,0.35}{#1}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.16,0.50,0.73}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.96,0.45,0.00}{#1}}
\newcommand{\BuiltInTok}[1]{\textcolor[rgb]{0.50,0.55,0.55}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.24,0.68,0.91}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.48,0.49,0.49}{#1}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.50,0.55,0.55}{#1}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.15,0.68,0.68}{\textbf{#1}}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.99,0.74,0.29}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.16,0.50,0.73}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.96,0.45,0.00}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.64,0.20,0.25}{#1}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.85,0.27,0.33}{\underline{#1}}}
\newcommand{\ExtensionTok}[1]{\textcolor[rgb]{0.00,0.60,1.00}{\textbf{#1}}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.96,0.45,0.00}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.56,0.27,0.68}{#1}}
\newcommand{\ImportTok}[1]{\textcolor[rgb]{0.15,0.68,0.38}{#1}}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.77,0.36,0.00}{#1}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.81,0.81,0.76}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{\textcolor[rgb]{0.81,0.81,0.76}{#1}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.81,0.76}{#1}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.15,0.68,0.38}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.15,0.68,0.38}{#1}}
\newcommand{\RegionMarkerTok}[1]{\textcolor[rgb]{0.16,0.50,0.73}{\colorbox[rgb]{0.08,0.19,0.26}{#1}}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.24,0.68,0.91}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.85,0.27,0.33}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.96,0.31,0.31}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.15,0.68,0.68}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.85,0.27,0.33}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.85,0.27,0.33}{#1}}

\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\newsavebox\pandoc@box
\newcommand*\pandocbounded[1]{% scales image to fit in text height/width
  \sbox\pandoc@box{#1}%
  \Gscale@div\@tempa{\textheight}{\dimexpr\ht\pandoc@box+\dp\pandoc@box\relax}%
  \Gscale@div\@tempb{\linewidth}{\wd\pandoc@box}%
  \ifdim\@tempb\p@<\@tempa\p@\let\@tempa\@tempb\fi% select the smaller of both
  \ifdim\@tempa\p@<\p@\scalebox{\@tempa}{\usebox\pandoc@box}%
  \else\usebox{\pandoc@box}%
  \fi%
}
% Set default figure placement to htbp
\def\fps@figure{htbp}
\makeatother

% Float for H!
\usepackage{float} 

% Citation settings
\usepackage[backend = biber, style = apa]{biblatex}

% Set Font
\addtokomafont{disposition}{\rmfamily} 

% Set code size
\AddToHook{env/Highlighting/begin}{\scriptsize} 

% Bibliography file 
\addbibresource{../../bibliography/bibliography.bib}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{array}
\usepackage{multirow}
\usepackage{wrapfig}
\usepackage{float}
\usepackage{colortbl}
\usepackage{pdflscape}
\usepackage{tabu}
\usepackage{threeparttable}
\usepackage{threeparttablex}
\usepackage[normalem]{ulem}
\usepackage{makecell}
\usepackage{xcolor}
\KOMAoption{captions}{tableheading}
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\AtBeginDocument{%
\ifdefined\contentsname
  \renewcommand*\contentsname{Table of contents}
\else
  \newcommand\contentsname{Table of contents}
\fi
\ifdefined\listfigurename
  \renewcommand*\listfigurename{List of Figures}
\else
  \newcommand\listfigurename{List of Figures}
\fi
\ifdefined\listtablename
  \renewcommand*\listtablename{List of Tables}
\else
  \newcommand\listtablename{List of Tables}
\fi
\ifdefined\figurename
  \renewcommand*\figurename{Figure}
\else
  \newcommand\figurename{Figure}
\fi
\ifdefined\tablename
  \renewcommand*\tablename{Table}
\else
  \newcommand\tablename{Table}
\fi
}
\@ifpackageloaded{float}{}{\usepackage{float}}
\floatstyle{ruled}
\@ifundefined{c@chapter}{\newfloat{codelisting}{h}{lop}}{\newfloat{codelisting}{h}{lop}[chapter]}
\floatname{codelisting}{Listing}
\newcommand*\listoflistings{\listof{codelisting}{List of Listings}}
\makeatother
\makeatletter
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\@ifpackageloaded{subcaption}{}{\usepackage{subcaption}}
\makeatother

\usepackage{bookmark}

\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={Data building},
  pdfauthor={Stepan Polikanov},
  colorlinks=true,
  linkcolor={blue},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}


\title{Data building}
\usepackage{etoolbox}
\makeatletter
\providecommand{\subtitle}[1]{% add subtitle to \maketitle
  \apptocmd{\@title}{\par {\large #1 \par}}{}{}
}
\makeatother
\subtitle{Peasant unrest and imperial repression}
\author{Stepan Polikanov}
\date{}

\begin{document}
\maketitle


\begin{Shaded}
\begin{Highlighting}[]
\DocumentationTok{\#\# Building data for the analysis}
\DocumentationTok{\#\# Dependencies: data\_raw folder}

\FunctionTok{source}\NormalTok{(here}\SpecialCharTok{::}\FunctionTok{here}\NormalTok{(}\StringTok{"utilities"}\NormalTok{, }\StringTok{"check\_packages.R"}\NormalTok{))}
\FunctionTok{source}\NormalTok{(here}\SpecialCharTok{::}\FunctionTok{here}\NormalTok{(}\StringTok{"utilities"}\NormalTok{, }\StringTok{"functions.R"}\NormalTok{))}

\FunctionTok{conflicts\_prefer}\NormalTok{(sfnetworks}\SpecialCharTok{::}\NormalTok{activate)}
\FunctionTok{conflicts\_prefer}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{filter)}
\FunctionTok{conflicts\_prefer}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{lag)}
\FunctionTok{conflicts\_prefer}\NormalTok{(dplyr}\SpecialCharTok{::}\NormalTok{select)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Repression data}

  \DocumentationTok{\#\# deprivation}
\NormalTok{  deprivation }\OtherTok{\textless{}{-}} \FunctionTok{read\_excel}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_raw"}\NormalTok{, }\StringTok{"grigoriadis\_repression"}\NormalTok{, }
                                 \StringTok{"data\_result"}\NormalTok{, }
                                 \StringTok{"results\_deprivation\_geolocated.xlsx"}\NormalTok{))}
  
  \DocumentationTok{\#\# okhrana}
\NormalTok{  okhrana }\OtherTok{\textless{}{-}} \FunctionTok{read\_excel}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_raw"}\NormalTok{, }\StringTok{"grigoriadis\_repression"}\NormalTok{, }
                             \StringTok{"data\_result"}\NormalTok{, }
                             \StringTok{"results\_okhrana\_geolocated.xlsx"}\NormalTok{), }
                        \AttributeTok{guess\_max =} \DecValTok{13956}\NormalTok{)}
  
\CommentTok{\# Unrest data}
  
  \DocumentationTok{\#\# Replication data from "Does Reform Prevent Rebellion? Evidence From }
  \DocumentationTok{\#\# Russia’s Emancipation of the Serfs" {-} https://doi.org/10.7910/DVN/29018}
\NormalTok{  finkel }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(here}\SpecialCharTok{::}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_raw"}\NormalTok{, }
                                  \StringTok{"finkel\_replication"}\NormalTok{, }\StringTok{"2014.07.12.tab"}\NormalTok{), }
                     \AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{na.strings =} \DecValTok{9999}\NormalTok{)}
  
  \DocumentationTok{\#\# Replication data from "Collective Action and Representation in Autocracies: }
  \DocumentationTok{\#\# Evidence from Russia\textquotesingle{}s Great Reforms" {-} https://doi.org/10.1017/S0003055417000454}
\NormalTok{  dower\_variables }\OtherTok{\textless{}{-}} \FunctionTok{read\_dta}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_raw"}\NormalTok{, }\StringTok{"dower\_replication"}\NormalTok{, }
                                   \StringTok{"variables\_replication.dta"}\NormalTok{))}
\NormalTok{  dower\_events }\OtherTok{\textless{}{-}} \FunctionTok{read\_dta}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_raw"}\NormalTok{, }\StringTok{"dower\_replication"}\NormalTok{, }
                                \StringTok{"event\_data\_replication.dta"}\NormalTok{))}
  
  \CommentTok{\# occupations {-} province}
\NormalTok{  province\_level }\OtherTok{\textless{}{-}} \FunctionTok{read\_rds}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_raw"}\NormalTok{, }\StringTok{"master\_merged.rds"}\NormalTok{))}
  
  \CommentTok{\# serfdom data}
\NormalTok{  serfdom\_data\_province }\OtherTok{\textless{}{-}} \FunctionTok{read\_dta}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_raw"}\NormalTok{,}
                                          \StringTok{"20160144\_data"}\NormalTok{,}
                                          \StringTok{"replication\_province\_Serfdom.dta"}\NormalTok{))}

\NormalTok{  province\_gis }\OtherTok{\textless{}{-}} \FunctionTok{read\_sf}\NormalTok{(here}\SpecialCharTok{::}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_raw"}\NormalTok{, }\StringTok{"provinces\_1897.gpkg"}\NormalTok{))}

\NormalTok{  dictionary }\OtherTok{\textless{}{-}} \FunctionTok{read\_excel}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_hand"}\NormalTok{, }\StringTok{"dictionary.xlsx"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{occupations }\OtherTok{\textless{}{-}} \FunctionTok{read\_excel}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_raw"}\NormalTok{, }
                               \StringTok{"occupations1897\_1904\_cleaned.xlsx"}\NormalTok{))}

\NormalTok{occupations\_entire\_shares }\OtherTok{\textless{}{-}}\NormalTok{ occupations }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(type }\SpecialCharTok{==} \StringTok{"0 = entire"}\NormalTok{,}
\NormalTok{         province\_id }\SpecialCharTok{!=} \StringTok{"0"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(province,}
         \AttributeTok{agriculture\_1897 =}\NormalTok{ agriculture, }
         \AttributeTok{agr\_arable\_farming\_1897 =}\NormalTok{ agr\_arable\_farming,}
         \AttributeTok{manufacturing\_1897 =}\NormalTok{ manufacturing,}
         \AttributeTok{agriculture\_1904 =} \StringTok{\textasciigrave{}}\AttributeTok{1904\_agriculture}\StringTok{\textasciigrave{}}\NormalTok{,}
         \AttributeTok{agr\_arable\_farming\_1904 =} \StringTok{\textasciigrave{}}\AttributeTok{1904\_agr\_arable\_farming}\StringTok{\textasciigrave{}}\NormalTok{,}
         \AttributeTok{manufacturing\_1904 =} \StringTok{\textasciigrave{}}\AttributeTok{1904\_manufacturing}\StringTok{\textasciigrave{}}\NormalTok{,}
         \AttributeTok{population\_1897 =} \StringTok{\textasciigrave{}}\AttributeTok{1897\_pop}\StringTok{\textasciigrave{}}\NormalTok{,}
         \AttributeTok{population\_1904 =} \StringTok{\textasciigrave{}}\AttributeTok{1904\_both}\StringTok{\textasciigrave{}}\NormalTok{,}
         \AttributeTok{households\_1897 =}\NormalTok{ households,}
         \AttributeTok{households\_1904 =} \StringTok{\textasciigrave{}}\AttributeTok{1904\_households}\StringTok{\textasciigrave{}}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{agriculture\_share\_1897 =}\NormalTok{ agriculture\_1897 }\SpecialCharTok{/}\NormalTok{ households\_1897,}
         \AttributeTok{agr\_arable\_farming\_share\_1897 =}\NormalTok{ agr\_arable\_farming\_1897 }\SpecialCharTok{/}\NormalTok{ households\_1897,}
         \AttributeTok{manufacturing\_share\_1897 =}\NormalTok{ manufacturing\_1897 }\SpecialCharTok{/}\NormalTok{ households\_1897,}
         \AttributeTok{agriculture\_share\_1904 =}\NormalTok{ agriculture\_1904 }\SpecialCharTok{/}\NormalTok{ households\_1904,}
         \AttributeTok{agr\_arable\_farming\_share\_1904 =}\NormalTok{ agr\_arable\_farming\_1904 }\SpecialCharTok{/}\NormalTok{ households\_1904,}
         \AttributeTok{manufacturing\_share\_1904 =}\NormalTok{ manufacturing\_1904 }\SpecialCharTok{/}\NormalTok{ households\_1904)}

\NormalTok{urbanization }\OtherTok{\textless{}{-}}\NormalTok{ occupations }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(province\_id }\SpecialCharTok{!=} \StringTok{"0"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(province, }\AttributeTok{population\_1897 =} \StringTok{\textasciigrave{}}\AttributeTok{1897\_pop}\StringTok{\textasciigrave{}}\NormalTok{, }
         \AttributeTok{population\_1904 =} \StringTok{\textasciigrave{}}\AttributeTok{1904\_both}\StringTok{\textasciigrave{}}\NormalTok{, type) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ type, }
              \AttributeTok{values\_from =} \FunctionTok{c}\NormalTok{(population\_1897, population\_1904)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{transmute}\NormalTok{(province,}
            \AttributeTok{urbanization\_1897 =} \StringTok{\textasciigrave{}}\AttributeTok{population\_1897\_1 = urban}\StringTok{\textasciigrave{}} \SpecialCharTok{/} 
              \StringTok{\textasciigrave{}}\AttributeTok{population\_1897\_0 = entire}\StringTok{\textasciigrave{}}\NormalTok{,}
            \AttributeTok{urbanization\_1904 =} \StringTok{\textasciigrave{}}\AttributeTok{population\_1904\_1 = urban}\StringTok{\textasciigrave{}} \SpecialCharTok{/} 
              \StringTok{\textasciigrave{}}\AttributeTok{population\_1904\_0 = entire}\StringTok{\textasciigrave{}}\NormalTok{)}

\NormalTok{occupation\_urbanization }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(occupations\_entire\_shares, urbanization, }
                                 \AttributeTok{by =} \StringTok{"province"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Load raw data (adjust path as needed)}
\NormalTok{inequality }\OtherTok{\textless{}{-}} \FunctionTok{read\_excel}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_raw"}\NormalTok{, }\StringTok{"land\_inequality.xlsx"}\NormalTok{), }
                         \AttributeTok{skip =} \DecValTok{3}\NormalTok{)}

\FunctionTok{names}\NormalTok{(inequality) }\OtherTok{\textless{}{-}} \FunctionTok{sapply}\NormalTok{(}\FunctionTok{names}\NormalTok{(inequality), clean\_land\_column\_name)}

\CommentTok{\# Step 1: Drop peasants\_incl\_communes columns}
\NormalTok{inequality }\OtherTok{\textless{}{-}}\NormalTok{ inequality }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\FunctionTok{matches}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.peasants\_incl\_communes}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{."}\NormalTok{),}
         \SpecialCharTok{{-}}\FunctionTok{matches}\NormalTok{(}\StringTok{"}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{.all}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{."}\NormalTok{))}

\CommentTok{\# Step 2: Extract land and owner columns}
\NormalTok{land\_cols }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(inequality)[}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}land\_areas}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{."}\NormalTok{, }\FunctionTok{names}\NormalTok{(inequality))]}
\NormalTok{owner\_cols }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(inequality)[}\FunctionTok{grepl}\NormalTok{(}\StringTok{"\^{}n\_owners}\SpecialCharTok{\textbackslash{}\textbackslash{}}\StringTok{."}\NormalTok{, }\FunctionTok{names}\NormalTok{(inequality))]}

\CommentTok{\# Step 3: Reshape to long format}
\NormalTok{land\_long }\OtherTok{\textless{}{-}}\NormalTok{ inequality }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{select}\NormalTok{(province, }\FunctionTok{all\_of}\NormalTok{(land\_cols)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{pivot\_longer}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{province, }\AttributeTok{names\_to =} \StringTok{"var"}\NormalTok{, }\AttributeTok{values\_to =} \StringTok{"land\_area"}\NormalTok{)}

\NormalTok{owner\_long }\OtherTok{\textless{}{-}}\NormalTok{ inequality }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{select}\NormalTok{(province, }\FunctionTok{all\_of}\NormalTok{(owner\_cols)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{pivot\_longer}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{province, }\AttributeTok{names\_to =} \StringTok{"var"}\NormalTok{, }\AttributeTok{values\_to =} \StringTok{"owners"}\NormalTok{)}

\NormalTok{land\_parts }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(land\_long}\SpecialCharTok{$}\NormalTok{var, extract\_parts) }\SpecialCharTok{|\textgreater{}} \FunctionTok{bind\_rows}\NormalTok{()}
\NormalTok{owner\_parts }\OtherTok{\textless{}{-}} \FunctionTok{lapply}\NormalTok{(owner\_long}\SpecialCharTok{$}\NormalTok{var, extract\_parts) }\SpecialCharTok{|\textgreater{}} \FunctionTok{bind\_rows}\NormalTok{()}

\NormalTok{land\_long }\OtherTok{\textless{}{-}} \FunctionTok{bind\_cols}\NormalTok{(land\_long, land\_parts) }\SpecialCharTok{|\textgreater{}} \FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var, }\SpecialCharTok{{-}}\NormalTok{category)}
\NormalTok{owner\_long }\OtherTok{\textless{}{-}} \FunctionTok{bind\_cols}\NormalTok{(owner\_long, owner\_parts) }\SpecialCharTok{|\textgreater{}} \FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{var, }\SpecialCharTok{{-}}\NormalTok{category)}

\NormalTok{joined }\OtherTok{\textless{}{-}} \FunctionTok{left\_join}\NormalTok{(land\_long, owner\_long, }\AttributeTok{by =} \FunctionTok{c}\NormalTok{(}\StringTok{"province"}\NormalTok{, }\StringTok{"estate"}\NormalTok{, }
                                                  \StringTok{"bracket"}\NormalTok{))}

\NormalTok{joined }\OtherTok{\textless{}{-}}\NormalTok{ joined }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{mutate}\NormalTok{(}
    \AttributeTok{midpoint =} \FunctionTok{sapply}\NormalTok{(bracket, bracket\_midpoints),}
    \AttributeTok{total\_owners =}\NormalTok{ owners,}
    \AttributeTok{total\_land =}\NormalTok{ land\_area,}
    \AttributeTok{land\_per\_owner =} \FunctionTok{ifelse}\NormalTok{(owners }\SpecialCharTok{\textgreater{}} \DecValTok{0}\NormalTok{, land\_area }\SpecialCharTok{/}\NormalTok{ owners, }\DecValTok{0}\NormalTok{)}
\NormalTok{  )}

\NormalTok{gini\_by\_province }\OtherTok{\textless{}{-}}\NormalTok{ joined }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(province) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{land\_gini =} \FunctionTok{compute\_gini}\NormalTok{(}\FunctionTok{cur\_data\_all}\NormalTok{()), }\AttributeTok{.groups =} \StringTok{"drop"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{land\_shares }\OtherTok{\textless{}{-}}\NormalTok{ joined }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{left\_join}\NormalTok{(}\FunctionTok{select}\NormalTok{(inequality, province, }\AttributeTok{province\_land =}\NormalTok{ total\_land),}
            \AttributeTok{by =} \StringTok{"province"}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{filter}\NormalTok{(estate }\SpecialCharTok{\%in\%} \FunctionTok{c}\NormalTok{(}\StringTok{"nobility"}\NormalTok{, }\StringTok{"peasants\_excl\_communes"}\NormalTok{, }
                       \StringTok{"peasants\_communes\_only"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(province, estate) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{total\_land =} \FunctionTok{sum}\NormalTok{(total\_land, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{), }\AttributeTok{.groups =} \StringTok{"drop"}\NormalTok{,}
            \AttributeTok{province\_land =} \FunctionTok{first}\NormalTok{(province\_land)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{pivot\_wider}\NormalTok{(}\AttributeTok{names\_from =}\NormalTok{ estate, }\AttributeTok{values\_from =}\NormalTok{ total\_land, }
              \AttributeTok{values\_fill =} \DecValTok{0}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{peasant\_share =}\NormalTok{ (peasants\_excl\_communes }\SpecialCharTok{+}\NormalTok{ peasants\_communes\_only) }\SpecialCharTok{/} 
\NormalTok{           province\_land,}
         \AttributeTok{nobility\_share =}\NormalTok{ nobility }\SpecialCharTok{/}\NormalTok{ province\_land) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{select}\NormalTok{(province, peasant\_share, nobility\_share)}

\NormalTok{inequality2 }\OtherTok{\textless{}{-}} \FunctionTok{read\_excel}\NormalTok{(}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_raw"}\NormalTok{, }\StringTok{"land\_inequality.xlsx"}\NormalTok{), }
                          \AttributeTok{sheet =} \DecValTok{2}\NormalTok{)}

\NormalTok{nadels }\OtherTok{\textless{}{-}}\NormalTok{ inequality2 }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{state\_to\_private =}\NormalTok{ state\_church\_lands\_1000\_des}\SpecialCharTok{*}\DecValTok{1000}\SpecialCharTok{/}\NormalTok{total\_land,}
         \AttributeTok{nadel\_to\_private =}\NormalTok{ nadel\_lands}\SpecialCharTok{/}\NormalTok{total\_land)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{finkel }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(here}\SpecialCharTok{::}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_raw"}\NormalTok{, }\StringTok{"finkel\_replication"}\NormalTok{, }
                                \StringTok{"2014.07.12.tab"}\NormalTok{), }
                     \AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{, }\AttributeTok{na.strings =} \DecValTok{9999}\NormalTok{)}

\NormalTok{finkel\_gub }\OtherTok{\textless{}{-}} \FunctionTok{read.table}\NormalTok{(here}\SpecialCharTok{::}\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_raw"}\NormalTok{, }\StringTok{"finkel\_replication"}\NormalTok{, }
                                    \StringTok{"gub\_id.tab"}\NormalTok{), }
                          \AttributeTok{sep =} \StringTok{"}\SpecialCharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\AttributeTok{header =} \ConstantTok{TRUE}\NormalTok{)}

\NormalTok{finkel\_clean }\OtherTok{\textless{}{-}}\NormalTok{ finkel }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(Guberniya1) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarize}\NormalTok{(}\AttributeTok{events =} \FunctionTok{n}\NormalTok{()) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{left\_join}\NormalTok{(finkel\_gub, }\AttributeTok{by =} \FunctionTok{join\_by}\NormalTok{(}\StringTok{"Guberniya1"} \SpecialCharTok{==} \StringTok{"gub"}\NormalTok{)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{drop\_na}\NormalTok{(name)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{serfdom1858 }\OtherTok{\textless{}{-}}\NormalTok{ serfdom\_data\_province }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{group\_by}\NormalTok{(mapid, province\_name, sh\_serfs1858) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{summarise}\NormalTok{(}\AttributeTok{sh\_serfs1858 =} \FunctionTok{if\_else}\NormalTok{(}\FunctionTok{max}\NormalTok{(sh\_serfs1858) }\SpecialCharTok{==} \FunctionTok{min}\NormalTok{(sh\_serfs1858), }
                                   \FunctionTok{max}\NormalTok{(sh\_serfs1858), }\ConstantTok{NA}\NormalTok{),}
            \AttributeTok{grain\_prod =} \FunctionTok{mean}\NormalTok{(grain\_prod[year }\SpecialCharTok{\textless{}=} \DecValTok{1861}\NormalTok{], }\AttributeTok{na.rm =}\NormalTok{ T)) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{drop\_na}\NormalTok{(mapid) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{mutate}\NormalTok{(}\AttributeTok{mapid =} \FunctionTok{as.character}\NormalTok{(mapid))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{okhrana\_province }\OtherTok{\textless{}{-}}\NormalTok{ okhrana }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{filter}\NormalTok{(}\SpecialCharTok{!}\FunctionTok{is.na}\NormalTok{(gub)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{group\_by}\NormalTok{(gub) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{summarise}\NormalTok{(}
    \AttributeTok{total\_cases =} \FunctionTok{n}\NormalTok{(),}
    \AttributeTok{accused\_cases =} \FunctionTok{sum}\NormalTok{(data\_source }\SpecialCharTok{==} \StringTok{"accused"}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{revolutionary\_cases =} \FunctionTok{sum}\NormalTok{(data\_source }\SpecialCharTok{==} \StringTok{"revolutionaries"}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{),}
    \AttributeTok{observed\_cases =} \FunctionTok{sum}\NormalTok{(data\_source }\SpecialCharTok{==} \StringTok{"observation"}\NormalTok{, }\AttributeTok{na.rm =} \ConstantTok{TRUE}\NormalTok{)) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{arrange}\NormalTok{(}\FunctionTok{desc}\NormalTok{(total\_cases))}

\NormalTok{okhrana\_full }\OtherTok{\textless{}{-}} \FunctionTok{merge}\NormalTok{(okhrana\_province, dictionary, }
                      \AttributeTok{by.x =} \StringTok{"gub"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"okhrana"}\NormalTok{, }\AttributeTok{all.x =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{merge}\NormalTok{(finkel\_clean, }\AttributeTok{by.x =} \StringTok{"finkel"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"name"}\NormalTok{, }\AttributeTok{all.x =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{merge}\NormalTok{(province\_gis, }\AttributeTok{by.x =} \StringTok{"ristat\_ru"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"prov\_RU"}\NormalTok{, }\AttributeTok{all.x =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}}
  \FunctionTok{merge}\NormalTok{(serfdom1858, }\AttributeTok{by.x =} \StringTok{"Gub\_ID"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"mapid"}\NormalTok{, }\AttributeTok{all.x =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{merge}\NormalTok{(land\_shares, }\AttributeTok{by.x =} \StringTok{"inequality"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"province"}\NormalTok{, }\AttributeTok{all.x =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{merge}\NormalTok{(gini\_by\_province, }\AttributeTok{by.x =} \StringTok{"inequality"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"province"}\NormalTok{, }\AttributeTok{all.x =} \ConstantTok{TRUE}\NormalTok{) }\SpecialCharTok{|\textgreater{}} 
  \FunctionTok{merge}\NormalTok{(occupation\_urbanization, }\AttributeTok{by.x =} \StringTok{"occupations"}\NormalTok{, }\AttributeTok{by.y =} \StringTok{"province"}\NormalTok{, }
        \AttributeTok{all.x =} \ConstantTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{write\_rds}\NormalTok{(okhrana\_full, }\FunctionTok{here}\NormalTok{(}\StringTok{"data"}\NormalTok{, }\StringTok{"data\_built"}\NormalTok{, }\StringTok{"okhrana\_full.rds"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}





\end{document}
